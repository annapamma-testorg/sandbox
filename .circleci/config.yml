version: 2.1

jobs:
  my-test-job:
    machine: true
    steps:
      - run: |
          cat \<<EOT >> ~/.ssh/config
          UseRoaming no

          Host jumphost-base*.prod.circleci.com
            User circle

          Host kube-kubectl-us-east-1-*.infra.circleci.com
            User core
            StrictHostkeyChecking no
            ProxyCommand jumphost-base.prod.circleci.com

          Host kubectl-cci-*.infra.circleci.com
            User ec2-user
            StrictHostkeyChecking yes
            ProxyCommand jumphost-base.prod.circleci.com
          EOT
      - run:
          name: jumphost test
          command: |
            cat ~/.ssh/config
            ssh -f -N -L 9000:graylog-ui.infra.circleci.com:9000 jumphost-base.prod.circleci.com
            netstat -vanp tcp | grep 9000
            curl localhost:9000

workflows:
  tests:
    jobs:
      - my-test-job